<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Disponibilit√© des Consoles</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; background-image: url('bandeau.png'); background-size: cover; background-repeat: no-repeat; background-position: top center; padding-top: 180px; }
    header { background: white; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    header img { height: 100px; }
    h1 { text-align: center; color: #008cd0; margin-top: 0.5rem; }
    #console-list, #admin-controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; padding: 1rem; }
    .console { flex: 1 1 300px; max-width: 320px; background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); position: relative; }
    .console.alert { border: 3px solid red; background: #ffe5e5; }
    .console h2 { margin-top: 0; color: #333; }
    .admin-occupied-title { color: red !important; }
    .status { font-weight: bold; }
    .disponible { color: green; }
    .soon { color: orange; }
    .occupied { color: red; }
    .bar-container { height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 10px; }
    .bar-fill { height: 100%; background: #77b800; width: 0%; transition: width 1s; }
    .admin-panel { margin: 2rem; display: none; }
    .admin-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .admin-buttons button { flex: 1 1 45%; padding: 0.5rem; background: #008cd0; color: white; border: none; border-radius: 0.5rem; cursor: pointer; }
    .admin-buttons button:hover { background: #006ba1; }
    .manettes-select { margin-top: 0.5rem; }
    .status-icon { height: 20px; vertical-align: middle; margin-right: 8px; }
    .custom-time { margin-top: 0.5rem; }
    .custom-time input[type="time"] { margin-right: 0.5rem; padding: 0.3rem; border-radius: 0.3rem; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <img src="https://medialudotheque.ccghv.fr/images/template/pps_template02/logo.png" alt="Logo de la m√©diath√®que du Tilleul">
  </header>
  <h1>Disponibilit√© des Consoles</h1>
  <div id="console-list"></div>

  <div class="admin-panel" id="admin-panel">
    <h2>Panneau Admin</h2>
    <div id="admin-controls"></div>
  </div>

  <audio id="alert-sound" src="https://medialudotheque.ccghv.fr/files/arcade-ui-18-2295171.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvCCs5aCiou0qgXTwWEUpcVp7EaoNAroU",
      authDomain: "consoles-7861c.firebaseapp.com",
      databaseURL: "https://consoles-7861c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "consoles-7861c",
      storageBucket: "consoles-7861c.firebasestorage.app",
      messagingSenderId: "496836070107",
      appId: "1:496836070107:web:c1dcb41a50582f73159afe",
      measurementId: "G-4QM8M1VRVD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const consoles = [
      { id: 'ps5', nom: 'üéÆ PlayStation 5' },
      { id: 'switch', nom: 'üïπÔ∏è Nintendo Switch' },
      { id: 'xbox', nom: 'üéÆ Xbox Series X' }
    ];

    let state = {};
    let adminPassword = "admin2024";

    function saveStateToFirebase() {
      set(ref(db, 'consoleState'), state);
    }

    function occupy(id, minutes = 60) {
      const end = new Date();
      end.setMinutes(end.getMinutes() + minutes);
      state[id] = { ...state[id], status: 'occupied', endTime: end.toISOString() };
      saveStateToFirebase();
    }

    function release(id) {
      state[id] = { ...state[id], status: 'disponible', endTime: null };
      saveStateToFirebase();
    }

    function fermer(id) {
      state[id] = { ...state[id], status: 'ferme', endTime: null };
      saveStateToFirebase();
    }

    function animation(id) {
      state[id] = { ...state[id], status: 'animation', endTime: null };
      saveStateToFirebase();
    }

    function changeManettes(id, value) {
      state[id] = { ...state[id], manettes: parseInt(value) };
      saveStateToFirebase();
    }

    function setCustomEndTime(id) {
      const input = document.getElementById('custom-time-' + id);
      if (input && input.value) {
        const now = new Date();
        const [hours, minutes] = input.value.split(':');
        const customEnd = new Date(now);
        customEnd.setHours(parseInt(hours));
        customEnd.setMinutes(parseInt(minutes));
        customEnd.setSeconds(0);

        if (customEnd < now) {
          customEnd.setDate(customEnd.getDate() + 1);
        }

        state[id] = { ...state[id], status: 'occupied', endTime: customEnd.toISOString() };
        saveStateToFirebase();
      }
    }

    function updateDisplay() {
      const now = new Date();
      const list = document.getElementById('console-list');
      list.innerHTML = '';
      consoles.forEach(c => {
        const st = state[c.id];
        const div = document.createElement('div');
        div.className = 'console';
        const end = st.endTime ? new Date(st.endTime) : null;
        let statusText = '', statusClass = '', progressBar = '';

        if (st.status === 'disponible') {
          statusText = '‚úÖ Disponible';
          statusClass = 'disponible';
        } else if (st.status === 'ferme') {
          statusText = 'üö™ Ferm√©';
          statusClass = 'soon';
        } else if (st.status === 'animation') {
          statusText = 'üéâ En animation';
          statusClass = 'soon';
        } else {
          const diffRaw = (end - now) / 60000;
          const diff = Math.ceil(diffRaw);
          const duration = 60;
          const timeUsed = Math.min(duration, Math.max(0, duration - diffRaw));
          const percent = Math.min(100, Math.max(0, (timeUsed / duration) * 100));
          const endTimeStr = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          if (diff > 5) {
            statusText = `‚è≥ Occup√©e ‚Äì Libre dans ${diff} min (fin √† ${endTimeStr})`;
            statusClass = 'occupied';
          } else if (diff > 1) {
            statusText = `‚è∞ Fin proche ‚Äì ${diff} min restantes (fin √† ${endTimeStr})`;
            statusClass = 'soon';
          } else if (diff > 0) {
            statusText = `‚è∞ Fin proche ‚Äì moins de 1 min restante (fin √† ${endTimeStr})`;
            statusClass = 'soon';
          } else {
            statusText = `üö® Temps √©coul√© ‚Äì Merci de patienter, bient√¥t disponible`;
            statusClass = 'occupied';
            div.classList.add('alert');
            document.getElementById('alert-sound').play();
          }

          progressBar = `<div class='bar-container'><div class='bar-fill' style='width: ${100 - percent}%'></div></div>`;
        }

        div.innerHTML = `<h2>${c.nom}</h2><p class="status ${statusClass}">${statusText}</p>${progressBar}`;
        list.appendChild(div);
      });
    }

    function updateAdminDisplay() {
      const now = new Date();
      const admin = document.getElementById('admin-controls');
      admin.innerHTML = '';
      consoles.forEach(c => {
        const st = state[c.id];
        const div = document.createElement('div');
        div.className = 'console';
        const end = st.endTime ? new Date(st.endTime) : null;
        const titleClass = st.status === 'occupied' ? 'admin-occupied-title' : '';
        let content = `<h2 class="${titleClass}">${c.nom}</h2><p>Manettes utilis√©es : ${st.manettes}</p>`;

        if (st.status === 'occupied') {
          const diff = Math.ceil((end - now) / 60000);
          const endTimeStr = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          if (diff <= 0) {
            div.classList.add('alert');
            document.getElementById('alert-sound').play();
            content += `<p>D√©pass√© de ${Math.abs(diff)} min</p>`;
          } else {
            content += `<p>Fin dans ${diff} min (√† ${endTimeStr})</p>`;
          }
        } else {
          content += `<p>Statut : ${st.status}</p>`;
        }

        content += `
          <label for="manettes-${c.id}">Manettes :</label>
          <select id="manettes-${c.id}" class="manettes-select" onchange="changeManettes('${c.id}', this.value)">
            ${[1, 2, 3, 4].map(n => `<option value="${n}" ${st.manettes == n ? 'selected' : ''}>${n}</option>`).join('')}
          </select>

          <div class="admin-buttons">
            <button onclick="occupy('${c.id}')">Occuper 1h</button>
            <button onclick="release('${c.id}')">Lib√©rer</button>
            <button onclick="fermer('${c.id}')">Ferm√©</button>
            <button onclick="animation('${c.id}')">Animation</button>
          </div>

          <div class="custom-time">
            <label for="custom-time-${c.id}">D√©finir l'heure de fin :</label>
            <input type="time" id="custom-time-${c.id}">
            <button onclick="setCustomEndTime('${c.id}')">Appliquer</button>
          </div>
        `;

        div.innerHTML = content;
        admin.appendChild(div);
      });
    }

    function checkAdminAccess() {
      const code = prompt("Mot de passe admin :");
      if (code === adminPassword) {
        document.getElementById('admin-panel').style.display = 'block';
      }
    }

    onValue(ref(db, 'consoleState'), snapshot => {
      if (snapshot.exists()) {
        state = snapshot.val();
      } else {
        consoles.forEach(c => {
          state[c.id] = { status: 'disponible', endTime: null, manettes: 1 };
        });
        saveStateToFirebase();
      }
      updateDisplay();
      updateAdminDisplay();
    });

    window.occupy = occupy;
    window.release = release;
    window.fermer = fermer;
    window.animation = animation;
    window.changeManettes = changeManettes;
    window.setCustomEndTime = setCustomEndTime;
    window.checkAdminAccess = checkAdminAccess;
  </script>

  <button onclick="checkAdminAccess()">Mode Admin</button>
</body>
</html>

